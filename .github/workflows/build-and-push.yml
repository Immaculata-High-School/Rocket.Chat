name: Build and Push Docker Image

on:
  push:
    branches:
      - master
      - develop
  workflow_dispatch:

env:
  TURBO_TELEMETRY_DISABLED: 1
  # Change this to your Docker Hub username/image name
  DOCKERHUB_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/rocket-chat

jobs:
  build:
    name: Build and Push
    runs-on: ubuntu-24.04
    timeout-minutes: 60

    permissions:
      contents: read
      packages: write

    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: false

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 4

      - name: Get versions from package.json
        id: versions
        run: |
          NODE_VERSION=$(node -p "require('./package.json').engines.node")
          echo "node-version=${NODE_VERSION}" >> $GITHUB_OUTPUT
          
          DENO_VERSION=$(awk '$1=="deno"{ print $2 }' .tool-versions)
          echo "deno-version=${DENO_VERSION}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.versions.outputs.node-version }}
          cache: 'yarn'

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ steps.versions.outputs.deno-version }}

      - name: Turbo Cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-

      - name: Cache meteor local
        uses: actions/cache@v4
        with:
          path: ./apps/meteor/.meteor/local
          key: meteor-local-cache-${{ runner.OS }}-${{ hashFiles('apps/meteor/.meteor/versions') }}
          restore-keys: |
            meteor-local-cache-${{ runner.os }}-

      - name: Cache meteor
        uses: actions/cache@v4
        with:
          path: ~/.meteor
          key: meteor-cache-${{ runner.OS }}-${{ hashFiles('apps/meteor/.meteor/release') }}
          restore-keys: |
            meteor-cache-${{ runner.os }}-

      - name: Install Meteor
        run: |
          set +e
          METEOR_SYMLINK_TARGET=$(readlink ~/.meteor/meteor)
          METEOR_TOOL_DIRECTORY=$(dirname "$METEOR_SYMLINK_TARGET")
          set -e
          LAUNCHER=$HOME/.meteor/$METEOR_TOOL_DIRECTORY/scripts/admin/launch-meteor
          if [ -e $LAUNCHER ]; then
            echo "Cached Meteor bin found, restoring it"
            sudo cp "$LAUNCHER" "/usr/local/bin/meteor"
          else
            echo "No cached Meteor bin found."
          fi
          command -v meteor >/dev/null 2>&1 || curl https://install.meteor.com | sed s/--progress-bar/-sL/g | /bin/sh

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build Rocket.Chat
        run: yarn build:ci
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"

      - name: Prepare build
        run: |
          cd /tmp/dist
          tar czf /tmp/Rocket.Chat.tar.gz bundle

      - name: Extract build for Docker
        run: |
          mkdir -p /tmp/build
          cd /tmp/build
          tar xzf /tmp/Rocket.Chat.tar.gz

      - name: Free up space before Docker build
        run: |
          rm -rf node_modules
          rm -rf apps/meteor/.meteor/local
          rm -rf ~/.meteor
          rm -rf /tmp/Rocket.Chat.tar.gz
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: /tmp/build
          file: ${{ github.workspace }}/apps/meteor/.docker/Dockerfile.alpine
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
